---
layout: post
title: Exploitation of CVE-2009-1869
date: '2009-08-03T21:12:00.001+03:00'
author: Roee Hay
tags: 
modified_time: '2009-08-03T21:12:15.399+03:00'
---

<p>During the research of the Flash vulnerability I’ve managed to create a functional PoC.    <br />    <br />The process of the exploit is the following:</p>  <ol>   <li>Spray the heap in order to achieve the following:</li>    <ol>     <li>The aforementioned path conditions would pass.</li>      <li>A DWORD memory overwrite with user controlled target and value would take place when the vulnerability is triggered.</li>      <li>Allocate a placeholder for the shellcode. The target of the memory overwrite would be some function pointer, the value would be the location of the shellcode’s placeholder. </li>   </ol>    <li>Trigger the vulnerability.</li>    <li>Free the placeholder of the shellcode. </li>    <li>Allocate the shellcode by spraying the heap.</li>    <li>Trigger some function which calls the function pointer. </li> </ol>  <p>The reason that there are 2 passes for allocating the shellcode is the fact that after the arbitrary overwrite occurs, some random chunks are also written to the location of the shellcode, hence the block has to be freed and re-allocated.</p>  <p>The exploit contains the following components:</p>  <ol>   <li>     <div><strong>Exploit.fla/as – </strong>main code</div>   </li>    <li>     <div><strong>HeapLib.as – </strong>ActionScript3 Heap Spraying library        <br />The Heap Spraying library bypasses the ActionScript’s maximum execution time limitation by using a Timer that allocates small chunks at each iteration.        <br />It provides two basics functions:         <br />1) <font face="Consolas">alloc(value, size)          <br /></font>2) <font face="Consolas">free()</font></div>   </li>    <li>     <div><strong>TriggerVuln.swf </strong>-<strong>&#160; </strong>malformed SWF which triggers the vulnerability (i.e: intf_count=0)</div>   </li>    <li>     <div><strong>TriggerFunc.fla – </strong>ActionScript2 code which triggers a call to the function pointer by invoking <a href="http://www.adobe.com/actionscript_dictionary435.html"><font color="#000000" face="Consolas">LoadVars.sendAndLoad</font></a></div>   </li>    <li>     <div><strong>Exploit.htm – </strong>HTML wrapper for the Exploit.as        <br /></div>   </li> </ol>  <p>The exploit has been tested against Windows XP SP3 with IE7. Flash is assumed to be loaded at VA 0x10000000. However, since the vulnerable code is wrapped by a permissive SEH handler, brute-force is possible (not covered by the PoC).</p>  <p>The binaries and source code of the PoC can be found <a href="http://code.google.com/p/roeehay">here</a>.</p>  
